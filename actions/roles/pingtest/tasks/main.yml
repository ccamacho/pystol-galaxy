---
#
# Begining of mandatory lines
#
- debug:
    msg: "Ansible execution of action: {{ pystol_action_id }}"

- name: Update the CR with the start of the action
  block:
  - name: Apply the result CR
    shell: "kubectl patch pystolactions {{ pystol_action_id }} --type='json' -p='[{\"op\": \"replace\", \"path\": \"/spec/action_state\", \"value\":\"RUN\"}]'"
#
# End of mandatory lines
#

- name: Action execution block
  block:
  - name: Gather some real facts from the role
    pystol.actions.real_facts:
      name: This is a test
    register: testout
  - debug:
      msg: "{{ testout }}"
  - name: Get a list of all pods from any namespace
    k8s_info:
      kind: Pod
    register: pingtest_pod_list
  - debug: var=pingtest_pod_list
  - name: Get the Internal IP of the first node
    shell: kubectl get nodes -o jsonpath='{ $.items[*].status.addresses[?(@.type=="InternalIP")].address }' | head -1
    register: pingtest_node_ip
  - debug: var=pingtest_node_ip.stdout
  - name: Ping the internal IP of a node from the pod
    command: "ping -c 2 {{ pingtest_node_ip.stdout }}"
    register: ping_result
    failed_when: >
      ("100% packet loss" in ping_result.stdout) or
      (ret.stderr != '') or
      (ret.rc == 10)
#
# Begining of mandatory lines
#
  - name: Apply the result CR
    shell: "kubectl patch pystolactions {{ pystol_action_id }} --type='json' -p='[{\"op\": \"replace\", \"path\": \"/spec/action_state\", \"value\":\"FPA\"}]'"
  rescue:
    - name: Apply the  result CR
      shell: "kubectl patch pystolactions {{ pystol_action_id }} --type='json' -p='[{\"op\": \"replace\", \"path\": \"/spec/action_state\", \"value\":\"FFA\"}]'"
  always:
    - name: Update the CR with the end of the action
      block:
      - name: Apply the result CR
        shell: "kubectl patch pystolactions {{ pystol_action_id }} --type='json' -p='[{\"op\": \"replace\", \"path\": \"/spec/action_result\", \"value\":\"{{ ping_result.stdout | from_json }}\"}]'"
#
# End of mandatory lines
#
